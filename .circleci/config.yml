version: 2
jobs:
  build:
    docker:
      - image: aperezdc/ci-wpebackend:latest
        user: build
    steps:
      - checkout
      - run:
          name: Prepare
          command: |
            rm -rf _p output
            mkdir -p _p/src/_build output
            curl -sLo _p/PKGBUILD 'https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=libwpe-git'
            ln -sf "$(pwd)" _p/src/libwpe-git
            cd _p
      - run:
          name: Build
          command: |
            cd _p
            makepkg --skipinteg --nosign --noextract --force --nocolor
      - run:
          name: Check
          command: |
            cd _p
            while read -r pkg ; do
              echo "=== $(basename "${pkg}") ==="
              namcap "${pkg}"
              ln "${pkg}" ../output/
            done < <(makepkg --packagelist) | tee ../output/namcap.log
      - store_artifacts:
          path: output/
